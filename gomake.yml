variables: 
  goarchs: "amd64|arm64|386|arm"
  gooss: "darwin|linux|windows"
  dist: "dist"
  binary: "gomake"
  dockername: "fasibio/gomake"
  version: "1.0.27"
  dockerfile: Dockerfile.gomake
---
{{$root := .}}

buildAll: 
  script: 
    {{include "build"}}
    {{include "buildDocker"}}
    {{include "test"}}
  on_failure: 
    {{include "build"}}
    {{include "buildDocker"}}

build: 
  script: 
    - mkdir {{.Var.dist}}
    {{- range $goosKey, $goos := splitList "|" $root.Var.gooss}}
      {{- range $goarchKey, $goarch := splitList "|" $root.Var.goarchs}}
    - env GOOS={{$goos}} GOARCH={{$goarch}} go build -o {{$root.Var.dist}}/{{$root.Var.binary}}_{{$goos}}_{{$goarch}}
      {{- end}}
    {{- end}}
  on_failure: 
    - rm -rf {{.Var.dist}}
buildDocker: 
  script: 
    - docker build -t {{$root.Var.dockername}}:{{$root.Var.version}} -f {{$root.Var.dockerfile}} .
  on_failure: 
    - docker rmi {{$root.Var.dockername}}:{{$root.Var.version}}

test: 
  script: 
    - docker run --rm {{$root.Var.dockername}}:{{$root.Var.version}} --help